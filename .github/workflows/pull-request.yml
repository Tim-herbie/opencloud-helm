name: Lint Helm Chart and Create Prerelease

on:
  pull_request:
    paths:
      - 'charts/opencloud'
  workflow_dispatch:

jobs:
  lint-and-prerelease:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Lint Helm chart
        run: |
          echo "Linting charts/opencloud..."
          helm lint charts/opencloud

      - name: Generate prerelease version
        id: version
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          CURRENT_VERSION=$(grep '^version:' charts/opencloud/Chart.yaml | awk '{print $2}')
          PRERELEASE_VERSION="${CURRENT_VERSION}-${TIMESTAMP}"
          echo "prerelease_version=${PRERELEASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "timestamp=${TIMESTAMP}" >> "$GITHUB_OUTPUT"

      - name: Update Chart.yaml with prerelease version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.prerelease_version }}/" charts/opencloud/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package charts/opencloud --destination ./packaged-charts

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push chart to GitHub Container Registry
        run: |
          helm push ./packaged-charts/opencloud-${{ steps.version.outputs.prerelease_version }}.tgz oci://ghcr.io/tim-herbie/opencloud-helm
